{% extends base_template %}

{% block body %}
<section style="background-color: #eee;">
  <div class="container my-5 py-5">

    {# Flash messages #}
    {% for label, messages in app.flashes %}
      {% for message in messages %}
        <div class="alert alert-{{ label }} mt-3 text-center">
          {{ message }}
        </div>
      {% endfor %}
    {% endfor %}

{% if is_employee %}
    <div class="row d-flex justify-content-center">
      <div class="col-md-12 col-lg-10 col-xl-8">
        {# New post section #}
        <div class="card mb-4">
          <div class="card-body">
            <form method="post" action="{{ path('app_statut_new') }}" id="newPostForm" enctype="multipart/form-data" novalidate>
              <div class="form-outline mb-3">
                <textarea name="contenu" id="postContent" class="form-control" rows="3" placeholder="What's on your mind?"></textarea>
              </div>
              
              {# Media preview area #}
              <div id="mediaPreview" class="mb-3 text-center" style="display: none;">
                <div class="preview-container">
                  <img id="imagePreview" class="img-fluid rounded" style="max-height: 300px; display: none;">
                  <video id="videoPreview" class="w-100 rounded" controls style="max-height: 300px; display: none;"></video>
                  <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeMedia()">
                    <i class="fas fa-times"></i> Remove
                  </button>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <input type="file" name="media" id="mediaInput" accept="image/*,video/*" style="display: none;">
                  <button type="button" class="btn btn-light" onclick="document.getElementById('mediaInput').click()">
                    <i class="fas fa-image"></i> Photo/Video
                  </button>
                  <span id="selectedFileName" class="ms-2"></span>
                </div>
                <div>
                <select id="languageSelect" class="form-select form-select-sm mb-2" style="width: auto; display: inline-block;">
    <option value="en-US" selected>English</option>
    <option value="fr-FR">Fran√ßais</option>
</select>
                 <button type="button" class="btn btn-light" id="voiceBtn">
<i class="fa-solid fa-microphone"></i>                  </button>
                  <button type="reset" class="btn btn-outline-secondary btn-sm" id="cancelPost">Cancel</button>
                  <button type="submit" class="btn btn-primary">Share</button>
                    

                </div>
              </div>
            </form>
          </div>
        </div>
{% endif %}

    {% for statut in statuts %}
      <div class="  card mb-4 "  id="post-{{ statut.id }}"> <!-- Use mb-4 for margin-bottom -->
        <div class="card-body">
          <div class="d-flex flex-start align-items-center">
            <img class="rounded-circle shadow-1-strong me-3"
              src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp"
              alt="avatar" width="60" height="60" />
            <div>
              <h6 class="fw-bold text-primary mb-1">{{ statut.user.prenom }}</h6>
              <p class="text-muted small mb-0">
                Shared publicly - {{ statut.dateCreation|date('Y-m-d') }}
              </p>
            </div>
          </div>

         
								<div class="post-content mt-3 mb-4 pb-2">
									<p class="post-text">{{ statut.contenu }}</p>
									{% if statut.mediaUrl %}
										<div class="text-center post-media">
											{% if statut.typeContenu == 'image' %}
												<img src="{{ statut.mediaUrl }}" class="img-fluid rounded mb-3" style="max-height: 500px;" alt="Post image">
											{% elseif statut.typeContenu == 'video' %}
												<video controls class="w-100 rounded mb-3" style="max-height: 500px;">
													<source src="{{ statut.mediaUrl }}" type="video/mp4">
													Your browser does not support the video tag.
												</video>
											{% endif %}
										</div>
									{% endif %}
								</div>

          <div class="d-flex justify-content-center gap-2">
            <div class="d-flex align-items-center gap-2">
              {# Check if the user has reacted to the statut #}
             {% set userReaction = statut.getReactions()|filter(r => r.user.id == app.user.id)|first %}
    
   <button type="button" 
            class="btn btn-sm {% if userReaction and userReaction.type == 'LIKE' %}btn-primary{% else %}btn-outline-primary{% endif %} rounded-pill"
            data-action="like" 
            data-statut-id="{{ statut.id }}">
        <i class="fas fa-thumbs-up me-1"></i>
        <span class="like-count">{{ statut.getReactions()|filter(r => r.type == 'LIKE')|length }}</span>
    </button>
   <button type="button" 
            class="btn btn-sm {% if userReaction and userReaction.type == 'DISLIKE' %}btn-danger{% else %}btn-outline-danger{% endif %} rounded-pill"
            data-action="dislike" 
            data-statut-id="{{ statut.id }}">
        <i class="fas fa-thumbs-down me-1"></i>
        <span class="dislike-count">{{ statut.getReactions()|filter(r => r.type == 'DISLIKE')|length }}</span>
    </button>
    <form action="{{ path('statut_favorite', {'id': statut.id}) }}" method="post" novalidate>
                <button type="button" class="btn btn-sm btn-outline-warning rounded-pill">
        <i class="fas fa-star me-1"></i>
    </button>
              </form>

              {# Admin View Button #}
              {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('app_statut_show', {'id': statut.id}) }}" class="btn btn-sm btn-outline-info rounded-pill">
                  <i class="fas fa-eye me-1"></i> View
                </a>
                
              {% endif %}

              {# Edit and Delete buttons for the owner #}
              {% if statut.user.id == app.user.id %}
           
                <button type="button" class="btn btn-sm btn-outline-success rounded-pill edit-post" data-post-id="{{ statut.id }}">
												<i class="fas fa-edit me-1"></i>
												Edit
											</button>
                      

                <form action="{{ path('app_statut_delete', {'id': statut.id}) }}" method="post" onsubmit="return confirm('Are you sure?');" style="display:inline;" novalidate>
                  <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ statut.id) }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </form>
              {% endif %}
            </div>
          </div>

          {# Show related comments #}
          <div class="mt-3"> <!-- Add margin-top to separate comments -->
            {% include 'forum/commentaire/index.html.twig' with {'commentaires': statut.commentaires} %}
          </div>

          {# Comment submission form #}
          <div class="card-footer py-3 border-0" style="background-color: #f8f9fa;">
            <form method="post" action="{{ path('app_commentaire_new', {'statutId': statut.id}) }}" novalidate>
              <div class="d-flex flex-start w-100">
                <img class="rounded-circle shadow-1-strong me-3"
                    src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp"
                    alt="avatar" width="40" height="40" />
                <div class="form-outline w-100">
                  <textarea name="contenu" class="form-control" rows="4" style="background: #fff;"></textarea>
                  <label class="form-label">Message</label>
                </div>
              </div>

              <input type="hidden" name="_token" value="{{ csrf_token('comment-add' ~ statut.id) }}">

              <div class="float-end mt-2 pt-1">
                <input type="hidden" name="statut_id" value="{{ statut.id }}">
                <button type="submit" class="btn btn-primary btn-sm">Post comment</button>
                <button type="reset" class="btn btn-outline-primary btn-sm">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning text-center">No posts available.</div>
    {% endfor %}

      </div>
    </div>
  </div>
</section>

    <script src="{{ asset('assets/js/forum.js') }}"></script>
    <script>
        ForumHandler.init({
            editToken: '{{ csrf_token('edit-post') }}',
            removeMediaToken: '{{ csrf_token('remove-media') }}'
        });
    </script>
    <script src="{{ asset('assets/js/voice-input.js') }}"></script>

{% endblock %}

{% block javascripts %}
{{ parent() }}
{% endblock %}
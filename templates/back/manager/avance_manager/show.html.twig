{% extends 'back/base.html.twig' %}

{% block body %}
<style>
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .clickable-row:hover {
        background-color: #f1f1f1;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .btn-sm i {
        margin-right: 4px;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">üìã D√©tails de la demande d'avance</h2>
  
  
{# Bloc de conversion de devises #}
<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex align-items-center bg-light">
    <i class="bi bi-currency-exchange fs-4 me-2"></i>
    <span class="fs-5">Conversion de devises</span>
  </div>
  <div class="card-body d-flex flex-wrap align-items-center" style="gap: 1rem;">
    {# Form-Floating pour la s√©lection #}
    <div class="form-floating flex-grow-1" style="max-width: 200px;">
      <select id="currency-select" class="form-select" aria-label="Devise cible">
        {% for curr in currencies %}
          <option value="{{ curr }}">{{ curr }}</option>
        {% endfor %}
      </select>
      <label for="currency-select">Devise cible</label>
    </div>

    {# Bouton de conversion #}
    <button id="convert-btn" class="btn btn-outline-primary d-flex align-items-center">
      <i class="bi bi-arrow-right-circle me-1"></i>
      Convertir
    </button>

    {# Affichage du r√©sultat #}
    <div id="conversion-results" class="ms-auto fs-5 text-success fw-bold"></div>
  </div>
</div>


    <div class="card">
        <div class="card-body">
            <ul class="list-group">
                <li class="list-group-item"><strong>Montant demand√© :</strong> {{ avance.montantDemande }} {{ avance.devise }}</li>
                        
                {# Ajout du montant accord√© #}
                <li class="list-group-item"><strong>Montant accord√© :</strong> 
                    {% if avance.statut == 'Trait√©' %}
                        {{ avance.montantAccorde }} {{ avance.devise }}
                    {% else %}
                        <span class="text-muted">Non encore trait√©</span>
                    {% endif %}
                </li>
                
                <li class="list-group-item"><strong>Motif :</strong> {{ avance.motif }}</li>
                <li class="list-group-item"><strong>Type d'avance :</strong> {{ avance.typeAvance }}</li>
                <li class="list-group-item"><strong>Statut :</strong> 
                    {% if avance.statut == 'Trait√©' %}
                        <span class="badge bg-success">‚úÖ Trait√©</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">‚è≥ En attente</span>
                    {% endif %}
                </li>
                <li class="list-group-item"><strong>Date de la demande :</strong> {{ avance.dateDemande ? avance.dateDemande|date('Y-m-d') : '' }}</li>
                <li class="list-group-item"><strong>Date de validation :</strong> {{ avance.dateValidation ? avance.dateValidation|date('Y-m-d') : 'Non valid√©e' }}</li>
                <li class="list-group-item"><strong>Commentaire manager :</strong> {{ avance.commentaireManager ?: 'Aucun commentaire' }}</li>
        
            </ul>
        </div>

        <div class="card-footer text-end">
            {% if avance.statut != 'Trait√©' %}
                <a href="{{ path('manager_traiter_avance', {'id': avance.id}) }}" class="btn btn-primary">
                    <i class="bi bi-pencil-square"></i> Traiter
                </a>
            {% endif %}
            <a href="{{ path('manager_avances') }}" class="btn btn-secondary">
                ‚Üê Retour √† la liste
            </a>
        </div>
    </div>
</div>

{# Script JS pour la conversion #}
<script>
  document.getElementById('convert-btn').addEventListener('click', function(e) {
    e.preventDefault();
    const amount = {{ amount|json_encode }};
    const from   = '{{ baseCurrency }}';
    const to     = document.getElementById('currency-select').value;
    const url    = '{{ path("currency_convert") }}'
                 + `?amount=${amount}&from=${from}&to=${to}`;

    fetch(url)
      .then(r => {
        if (!r.ok) throw new Error('Erreur r√©seau');
        return r.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          document.getElementById('conversion-results').textContent =
            `${to} : ${data.converted.toFixed(2)}`;
        }
      })
      .catch(err => {
        console.error(err);
        alert('Erreur lors de la conversion');
      });
  });
</script>

{% endblock %}
